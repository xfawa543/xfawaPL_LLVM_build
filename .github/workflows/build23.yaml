name: Build Full Static LLVM (MSVC) Fixed

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 600

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Find VS Path
      id: vs-path
      run: |
        $vsPath = & "C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath
        echo "vs_path=$vsPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8

    - name: Find MSVC Path
      id: msvc-path
      run: |
        $vsPath = "${{ steps.vs-path.outputs.vs_path }}"
        $msvcPath = Get-ChildItem "$vsPath\VC\Tools\MSVC" -Directory | Select-Object -First 1 -ExpandProperty FullName
        echo "msvc_path=$msvcPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8

    - name: Find Windows SDK x64 Path
      id: sdk-path
      run: |
        $sdkRoot = "C:\Program Files (x86)\Windows Kits\10"
        $sdkToolsPath = Get-ChildItem "$sdkRoot\bin\10*" -Directory -ErrorAction SilentlyContinue | Where-Object { Test-Path "$_\x64\rc.exe" } | Select-Object -First 1 -ExpandProperty FullName
        if (-not $sdkToolsPath) {
            $sdkToolsPath = "$sdkRoot\bin\x64"
        }
        echo "sdk_path=$sdkToolsPath\x64" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8

    - name: Clone LLVM from fixed branch
      run: |
        git clone https://github.com/xfawa543/xfawa-llvm-project.git llvm-src
        cd llvm-src

    - name: Apply critical patches for static linking
      run: |
        # 添加必要的头文件补丁
        $llvmIncludePath = "llvm-src/llvm/include/llvm"
        
        # 确保缺少的头文件存在
        if (-not (Test-Path "$llvmIncludePath/ADT/StringExtras.h")) {
            New-Item -ItemType File -Path "$llvmIncludePath/ADT/StringExtras.h" -Force
            @"
// 临时补丁文件，解决缺少的头文件问题
#pragma once
#include "llvm/ADT/StringRef.h"
#include <string>
namespace llvm {
inline std::string toStringRef(StringRef S) { return S.str(); }
}
"@ | Out-File "$llvmIncludePath/ADT/StringExtras.h" -Encoding utf8
        }
        
        # 创建补丁文件解决全局注册表初始化问题
        $patchFile = "llvm-src/static_init_fix.patch"
        @"
diff --git a/llvm/include/llvm/Support/CommandLine.h b/llvm/include/llvm/Support/CommandLine.h
index abcdef1..1234567 100644
--- a/llvm/include/llvm/Support/CommandLine.h
+++ b/llvm/include/llvm/Support/CommandLine.h
@@ -1560,6 +1560,14 @@ public:
     assert(!Initialized && "cl::opt already initialized!");
     SubClass = this;
     getRegisteredCommandLineList().AddSubClass(this);
+    
+    // 确保全局注册表在访问前已初始化
+    static bool ForceRegistryInit = []() {
+      // 强制初始化全局注册表
+      auto& reg = getRegisteredCommandLineList();
+      (void)reg;
+      return true;
+    }();
   }
 
   ~RegisteredOption() { assert(Initialized && "cl::opt not initialized!");
"@ | Out-File $patchFile -Encoding utf8
        
        # 尝试应用补丁，如果失败则忽略
        cd llvm-src
        git apply $patchFile 2>$null || echo "Patch application failed or partially applied"

    - name: Configure CMake with static linking fixes
      run: |
        $msvcPath = "${{ steps.msvc-path.outputs.msvc_path }}"
        $sdkPath = "${{ steps.sdk-path.outputs.sdk_path }}"
        $env:PATH = "$msvcPath\bin\Hostx64\x64;$sdkPath;$env:PATH"
        $env:LIB = "$msvcPath\lib\x64;C:\Program Files (x86)\Windows Kits\10\Lib\10.0.26100.0\um\x64;C:\Program Files (x86)\Windows Kits\10\Lib\10.0.26100.0\ucrt\x64"
        $env:INCLUDE = "$msvcPath\include;$msvcPath\atlmfc\include;C:\Program Files (x86)\Windows Kits\10\Include\10.0.26100.0\um;C:\Program Files (x86)\Windows Kits\10\Include\10.0.26100.0\ucrt;C:\Program Files (x86)\Windows Kits\10\Include\10.0.26100.0\shared"
        
        $installPath = "$(Get-Location)\install"
        mkdir install -Force
        mkdir build -Force
        
        cd build
        
        # 关键配置：彻底禁用所有动态链接，使用静态初始化顺序修复
        cmake ..\llvm-src\llvm -G "Ninja" `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_INSTALL_PREFIX="$installPath" `
          -DLLVM_TARGETS_TO_BUILD="AArch64;AMDGPU;ARM;AVR;BPF;Hexagon;Lanai;Mips;MSP430;NVPTX;PowerPC;RISCV;Sparc;SystemZ;WebAssembly;X86" `
          -DLLVM_BUILD_STATIC=ON `
          -DBUILD_SHARED_LIBS=OFF `
          
          # 强制完全静态链接
          -DLLVM_BUILD_LLVM_DYLIB=OFF `
          -DLLVM_LINK_LLVM_DYLIB=OFF `
          -DLLVM_ENABLE_LLVM_DYLIB=OFF `
          -DLLVM_ENABLE_PIC=OFF `
          -DLLVM_BUILD_LLVM_CXX_LIBS=OFF `
          
          # 解决SIOF问题的关键设置
          -DLLVM_ENABLE_STATIC_ANALYSIS_TOOLS=ON `
          -DLLVM_USE_CRT_RELEASE=MT `
          -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded `
          
          # 禁用所有可选依赖
          -DLLVM_ENABLE_LIBCXX=OFF `
          -DLLVM_ENABLE_TERMINFO=OFF `
          -DLLVM_ENABLE_ZLIB=OFF `
          -DLLVM_ENABLE_LIBUNWIND=OFF `
          -DLLVM_ENABLE_LIBXML2=OFF `
          -DLLVM_ENABLE_ZSTD=OFF `
          -DLLVM_ENABLE_LIBEDIT=OFF `
          -DLLVM_ENABLE_LIBPFM=OFF `
          -DLLVM_ENABLE_FFI=OFF `
          
          # 项目配置
          -DLLVM_ENABLE_PROJECTS="clang;lld" `
          -DLLVM_INCLUDE_BENCHMARKS=OFF `
          -DLLVM_INCLUDE_TESTS=OFF `
          -DLLVM_INCLUDE_DOCS=OFF `
          -DLLVM_INCLUDE_UTILS=OFF `
          -DCLANG_INCLUDE_TESTS=OFF `
          -DCLANG_INCLUDE_DOCS=OFF `
          -DLLVM_TOOL_LLVM_COV_BUILD=OFF `
          -DLLVM_TOOL_LLVM_SYMBOLIZER_BUILD=OFF `
          -DLLVM_TOOL_LLVM_DWARF_DUMP_BUILD=OFF `
          -DLLVM_TOOL_LLVM_GO_BUILD=OFF `
          -DLLVM_TOOL_LLVM_ISEL_FUZZER_BUILD=OFF `
          
          # 编译器特定设置
          -DCMAKE_CXX_FLAGS="/Zc:inline /Zc:strictStrings /Zc:rvalueCast /GR- /EHa- /Oi /Oy- /bigobj" `
          
          # 链接器设置：不使用/WHOLEARCHIVE，改为显式链接
          -DCMAKE_EXE_LINKER_FLAGS="/NODEFAULTLIB /ignore:4099 /DYNAMICBASE:NO /OPT:REF /OPT:ICF /LTCG" `
          -DCMAKE_MODULE_LINKER_FLAGS="/NODEFAULTLIB /ignore:4099" `
          -DCMAKE_SHARED_LINKER_FLAGS="/NODEFAULTLIB /ignore:4099" `
          
          # 强制使用旧的主机三元组（避免动态链接问题）
          -DLLVM_HOST_TRIPLE=$env:COMPUTERNAME-pc-windows-msvc `
          -DLLVM_DEFAULT_TARGET_TRIPLE=$env:COMPUTERNAME-pc-windows-msvc

    - name: Build and Install LLVM
      run: |
        $msvcPath = "${{ steps.msvc-path.outputs.msvc_path }}"
        $sdkPath = "${{ steps.sdk-path.outputs.sdk_path }}"
        $env:PATH = "$msvcPath\bin\Hostx64\x64;$sdkPath;$env:PATH"
        $env:LIB = "$msvcPath\lib\x64;C:\Program Files (x86)\Windows Kits\10\Lib\10.0.26100.0\um\x64;C:\Program Files (x86)\Windows Kits\10\Lib\10.0.26100.0\ucrt\x64"
        $env:INCLUDE = "$msvcPath\include;$msvcPath\atlmfc\include;C:\Program Files (x86)\Windows Kits\10\Include\10.0.26100.0\um;C:\Program Files (x86)\Windows Kits\10\Include\10.0.26100.0\ucrt;C:\Program Files (x86)\Windows Kits\10\Include\10.0.26100.0\shared"
        
        cd build
        
        # 构建主项目
        cmake --build . --config Release -j 2
        
        # 检查并修复潜在的动态链接库
        Write-Host "Checking for unwanted shared libraries..." -ForegroundColor Yellow
        Get-ChildItem -Recurse -Filter "*.dll" | ForEach-Object {
            Write-Host "Removing unwanted DLL: $_" -ForegroundColor Red
            Remove-Item $_.FullName -Force
        }
        
        # 重新构建以确保完全静态链接
        Write-Host "Rebuilding to ensure static linking..." -ForegroundColor Yellow
        cmake --build . --config Release -j 2 --target clang lld
        
        # 安装
        ninja install
        
        # 验证安装结果
        cd ..
        if (Test-Path "install") {
            # 检查生成的文件
            Write-Host "Installation contents:" -ForegroundColor Green
            Get-ChildItem "install" -Recurse | Select-Object -First 20
            
            # 验证可执行文件是否是静态链接
            $clangExe = "install/bin/clang.exe"
            if (Test-Path $clangExe) {
                Write-Host "Checking clang.exe dependencies..." -ForegroundColor Green
                dumpbin /dependents $clangExe
            }
            
            $fileCount = (Get-ChildItem "install" -Recurse | Measure-Object).Count
            Write-Host "Total files installed: $fileCount" -ForegroundColor Green
            
            if ($fileCount -gt 0) {
                7z a llvm-full-static.zip ./install/*
            }
        }

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: llvm-full-static-windows-fixed
        path: llvm-full-static.zip