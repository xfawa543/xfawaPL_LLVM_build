name: Build Static LLVM

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Install Visual Studio Build Tools
      uses: ilammy/setup-vs@v1
      with:
        components: |
          Microsoft.VisualStudio.Workload.VCTools
          Microsoft.VisualStudio.Component.VC.Tools.x86.x64
          Microsoft.VisualStudio.Component.Windows10SDK
      
    - name: Install Build Tools
      run: |
        # 安装 Chocolatey
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
        iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        
        # 安装必要的构建工具
        choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
        choco install ninja -y
        choco install 7zip -y
        
    - name: Clone LLVM
      run: |
        git clone https://github.com/llvm/llvm-project.git llvm-src
        cd llvm-src
        git checkout llvmorg-21.1.8
        
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake ../llvm-src/llvm ^
          -G "Ninja" ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DCMAKE_INSTALL_PREFIX=../install ^
          -DLLVM_BUILD_STATIC=ON ^
          -DBUILD_SHARED_LIBS=OFF ^
          -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded ^
          -DLLVM_ENABLE_ZLIB=OFF ^
          -DLLVM_ENABLE_TERMINFO=OFF ^
          -DLLVM_ENABLE_LIBEDIT=OFF ^
          -DLLVM_ENABLE_LIBXML2=OFF
          
    - name: Build LLVM
      run: |
        cd build
        cmake --build . --config Release --target install
        cd ../install
        7z a llvm-static.zip *
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: llvm-static-windows
        path: llvm-static.zip